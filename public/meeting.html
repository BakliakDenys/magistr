<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>–î–µ—Ç–∞–ª—ñ –∑—É—Å—Ç—Ä—ñ—á—ñ</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
  <style>
    body.hidden { display: none; }
    body *:not(button):not(.nav-button) {
      font-family: 'Patrick Hand', cursive;

  </style>
</head>
<body>

<div class="top-bar">
  <img id="avatarImage" alt="–ê–≤–∞—Ç–∞—Ä" class="avatar2">
  <div class="user-email" id="userEmail">email@example.com</div>
  <button id="authButton" class="logout-btn nav-button"></button>
</div>
  
<!-- –ö–Ω–æ–ø–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–µ–Ω—é -->
<button id="menuToggle" class="nav-button">‚ò∞ –ú–µ–Ω—é</button>

<!-- –ë–æ–∫–æ–≤–µ –º–µ–Ω—é -->
<div id="sideMenu" class="side-menu">
  <a href="/" class="nav-button">–ì–æ–ª–æ–≤–Ω–∞</a>
  <a href="/profile.html" class="nav-button">–ü—Ä–æ—Ñ—ñ–ª—å</a>
  <a href="/users.html" class="nav-button">–í—Å—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</a>
  <a href="/about.html" class="nav-button">–í—ñ–¥–≥—É–∫–∏</a>
  <a href="/mentor-matches.html" class="nav-button" id="recommendBtn">–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ñ –ø—Ä–æ—î–∫—Ç–∏</a>
  <button id="createMeetingToggle" class="nav-button submenu-toggle">
    –ó—É—Å—Ç—Ä—ñ—á—ñ ‚ñº
  </button>
  <div id="createMeetingSubmenu" class="submenu">
    <a href="/create-meeting.html" class="nav-button">‚ûï –ù–æ–≤–∞ –∑—É—Å—Ç—Ä—ñ—á</a>
    <a href="/meetings.html" class="nav-button">üìã –í—Å—ñ –∑—É—Å—Ç—Ä—ñ—á—ñ</a>
  </div>
</div>

<a href="/" class="floating-logo">
  <img src="/logo.PNG" alt="–õ–æ–≥–æ—Ç–∏–ø">
</a>

<div id="meetingDetails"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É -->
<button id="openChatBtn" class="nav-button" style="display: none;">–í—ñ–¥–∫—Ä–∏—Ç–∏ —á–∞—Ç</button>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —á–∞—Ç—É -->
<div id="chatContainer" >
  <button id="closeChatBtn" class="nav-button">–ó–∞–∫—Ä–∏—Ç–∏</button>
  <div class="highlight-box">
  <h4>–ß–∞—Ç –∑—É—Å—Ç—Ä—ñ—á—ñ</h4>
  </div>
  <div id="chatMessages" ></div>
  <form id="chatForm">
    <input type="text" id="chatInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." >
    <button type="submit" class="nav-button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
  </form>
</div>

<button id="joinButton" class="nav-button">–Ø –±—É–¥—É!</button>
<button id="deleteMeetingBtn" class="nav-button danger-btn">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –∑—É—Å—Ç—Ä—ñ—á</button>

<script src="script.js"></script>
<script src="create-meeting.js"></script>
<script src="meetings.js"></script>
<script>
  const token = localStorage.getItem('token');
  const userEmail = localStorage.getItem('email'); // Email –∑ localStorage
  const params = new URLSearchParams(window.location.search);
  const meetingId = params.get('id');
  let meeting = null; // –∑—Ä–æ–±–∏–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–º

  const chatContainer = document.getElementById('chatContainer');
  chatContainer.style.display = 'none'; // —Ö–æ–≤–∞—î–º–æ —á–∞—Ç –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º

  async function fetchMeeting() {
    const res = await fetch(`/api/meetings/${meetingId}`);
    meeting = await res.json();

    const details = document.getElementById('meetingDetails');
    details.innerHTML = `
      <img src="${meeting.imageUrl}" width="300">
      <h2>${meeting.title}</h2>
      <p><strong>–î–∞—Ç–∞:</strong> ${meeting.date}</p>
      <p><strong>–ß–∞—Å:</strong> ${meeting.startTime} ‚Äì ${meeting.endTime}</p>
      <p><strong>–ú—ñ—Å—Ü–µ:</strong> ${meeting.location}</p>
      <p><strong>–û–ø–∏—Å:</strong> ${meeting.description}</p>
      <p><strong>–£—á–∞—Å–Ω–∏–∫–∏ (${meeting.participants.length}/${meeting.maxParticipants}):</strong><br>
        ${meeting.participants.join(', ') || '–ù–µ–º–∞—î'}
      </p>
      <p><strong>–°—Ç–≤–æ—Ä–∏–≤:</strong> ${meeting.creatorEmail}</p>
    `;

    const joinBtn = document.getElementById('joinButton');
    if (meeting.participants.length >= meeting.maxParticipants) {
      joinBtn.textContent = '–ú—ñ—Å—Ü—å –Ω–µ–º–∞—î';
      joinBtn.classList.add('full');
      joinBtn.disabled = true;
    }

    joinBtn.onclick = async () => {
      if (!token) {
        alert("–£–≤—ñ–π–¥—ñ—Ç—å –¥–ª—è –∑–∞–ø–∏—Å—É");
        return;
      }

      const res = await fetch(`/api/meetings/${meetingId}/register`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`,
        },
      });

      if (res.ok) {
        alert('–í–∏ —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø–∏—Å–∞–ª–∏—Å—è!');
        await fetchMeeting(); // –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
        checkChatPermission(); // –æ–Ω–æ–≤–∏—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —á–∞—Ç—É
      } else {
        const data = await res.json();
        alert(data.message || '–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–ø–∏—Å–∞—Ç–∏—Å—è');
      }
    };

    checkChatPermission();
  }

  function checkChatPermission() {
    const openChatBtn = document.getElementById('openChatBtn'); // –î–æ–¥–∞—î–º–æ –∑–º—ñ–Ω–Ω—É –¥–ª—è –∫–Ω–æ–ø–∫–∏
    if (meeting && meeting.participants.includes(userEmail)) {
      openChatBtn.style.display = 'block'; // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É—á–∞—Å–Ω–∏–∫
      chatContainer.style.display = 'block';
      loadChat();
      if (!window.chatIntervalSet) {
        setInterval(loadChat, 5000); // –∞–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
        window.chatIntervalSet = true;
      }
    } else {
      openChatBtn.style.display = 'none'; // –°—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ —É—á–∞—Å–Ω–∏–∫
    }
  }

  async function loadChat() {
    const chatBox = document.getElementById('chatMessages');
    const res = await fetch(`/api/messages/${meetingId}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    if (res.ok) {
      const messages = await res.json();
      chatBox.innerHTML = messages.map(m => `
        <p><strong>${m.senderEmail}</strong>: ${m.text}</p>
      `).join('');
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  }

  document.getElementById('chatForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    if (!meeting.participants.includes(userEmail)) {
      alert("–¢—ñ–ª—å–∫–∏ —É—á–∞—Å–Ω–∏–∫–∏ –º–æ–∂—É—Ç—å –ø–∏—Å–∞—Ç–∏ –≤ —á–∞—Ç.");
      return;
    }

    const res = await fetch('/api/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify({ meetingId, text })
    });

    if (res.ok) {
      input.value = '';
      await loadChat();
    } else {
      alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è');
    }
  });

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É
  document.getElementById('openChatBtn').onclick = function() {
    chatContainer.classList.add('open');
    document.getElementById('openChatBtn').classList.add('hidden'); // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É
  };

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É
  document.getElementById('closeChatBtn').onclick = function() {
    chatContainer.classList.remove('open');
    document.getElementById('openChatBtn').classList.remove('hidden'); // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —á–∞—Ç—É
  };

  fetchMeeting();
</script>



</body>
</html>
